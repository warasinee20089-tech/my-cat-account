import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from datetime import datetime

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Meow Wallet v12.0 (iPhone & Anti-Translate Fix) ---
st.set_page_config(page_title="Meow Wallet Ultimate", layout="wide", page_icon="üêæ")

# ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Style ‡πÉ‡∏´‡πâ‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î‡πÉ‡∏ô iPhone
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap');
    
    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå */
    .stApp { background-color: #FFF5F7 !important; }
    html, body, [class*="css"], .stMarkdown, p, span, label { 
        font-family: 'Kanit', sans-serif !important; 
        color: #2D2D2D !important; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏î‡∏≥ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏µ‡∏î‡∏≥‡∏™‡∏ô‡∏¥‡∏ó */
    }
    
    .main-title { color: #FF69B4; text-align: center; font-size: clamp(24px, 5vw, 45px); font-weight: bold; padding: 10px; }
    
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
    div[data-testid="stMetric"] { background: white !important; border-radius: 15px; border: 2px solid #FFD1DC !important; padding: 15px; }
    .report-card { background-color: white; padding: 20px; border-radius: 15px; border-top: 5px solid #FF69B4; margin-bottom: 20px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); }
    
    /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    .translated-ltr { margin-top: 0 !important; }
    .goog-te-banner-frame { display: none !important; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
conn = sqlite3.connect('meow_ultimate_v12.db', check_same_thread=False)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS records 
             (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, date TEXT, 
              wallet TEXT, category TEXT, sub_category TEXT,
              income REAL DEFAULT 0, expense REAL DEFAULT 0, savings REAL DEFAULT 0)''')
conn.commit()

# --- 3. Sidebar ---
st.sidebar.markdown("<h2 style='text-align: center;'>üê± Meow Menu</h2>", unsafe_allow_html=True)
user_name = st.sidebar.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß", value="‡∏ß‡∏£‡∏≤‡∏®‡∏¥‡∏ì‡∏µ") # ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏û

if not user_name:
    st.markdown("<div class='main-title'>üêæ Meow Wallet Ultimate</div>", unsafe_allow_html=True)
    st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏ô‡∏∞‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß!")
    st.stop()

# --- 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
df = pd.read_sql(f"SELECT * FROM records WHERE user_id='{user_name}'", conn)
total_in = df['income'].sum() if not df.empty else 0
total_out = df['expense'].sum() if not df.empty else 0
total_save = df['savings'].sum() if not df.empty else 0
net_balance = total_in - total_out - total_save

# --- 5. Tabs ---
tab1, tab2, tab3, tab4, tab5 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "üéØ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°", "üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"])

with tab1:
    st.markdown(f"### ‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏∏‡∏ì {user_name})")
    col1, col2 = st.columns([1, 1])
    
    with col1:
        date_in = st.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
        wallet_in = st.selectbox("üëõ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
        type_in = st.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞", "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"], horizontal=True)
    
    with col2:
        if type_in == "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞":
            cat_list = ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üí∏", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™ üéÅ", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á üõçÔ∏è", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]
        elif type_in == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏":
            cat_list = ["‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç±", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° ‚òï", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á üöó", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á üõçÔ∏è", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]
        else:
            cat_list = ["‡∏≠‡∏≠‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß üè¶", "‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô üöë", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]
            
        selected_cat = st.selectbox("üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", cat_list)
        
        final_category = selected_cat
        if selected_cat == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï":
            final_category = st.text_input("‚úçÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏≠‡∏á", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥‡πÅ‡∏°‡∏ß...")
            
        sub_cat_in = st.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏ô‡πâ‡∏ï‡∏Å‡∏±‡∏ô‡∏•‡∏∑‡∏°...")
        amt_in = st.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0, step=1.0)

    if st.button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", use_container_width=True):
        if amt_in > 0 and final_category != "":
            inc, exp, sav = (amt_in, 0, 0) if type_in == "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞" else (0, amt_in, 0) if type_in == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏" else (0, 0, amt_in)
            c.execute("INSERT INTO records (user_id, date, wallet, category, sub_category, income, expense, savings) VALUES (?,?,?,?,?,?,?,?)", 
                      (user_name, date_in.strftime('%Y-%m-%d'), wallet_in, final_category, sub_cat_in, inc, exp, sav))
            conn.commit()
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß!")
            st.rerun()

with tab2:
    st.markdown("### üè¶ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠")
    df_w = pd.read_sql(f"SELECT wallet, SUM(income) as inc, SUM(expense) as exp, SUM(savings) as sav FROM records WHERE user_id='{user_name}' GROUP BY wallet", conn)
    c_wallets = st.columns(3)
    wallets = ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"]
    for i, w_name in enumerate(wallets):
        row = df_w[df_w['wallet'] == w_name]
        bal = row['inc'].sum() - row['exp'].sum() - row['sav'].sum() if not row.empty else 0.0
        c_wallets[i].metric(w_name, f"{bal:,.2f} ‡∏ø")

with tab5:
    st.markdown("### üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
    if not df.empty:
        df_show = df.sort_values(by=['date', 'id'], ascending=[False, False])
        st.dataframe(df_show[['date', 'wallet', 'category', 'sub_category', 'income', 'expense', 'savings']], use_container_width=True)
        csv = df_show.to_csv(index=False).encode('utf-8-sig')
        st.download_button("üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", data=csv, file_name=f'meow_backup_{user_name}.csv')
    else:
        st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞!")

st.sidebar.markdown("---")
st.sidebar.write("üê± *Meow Wallet v12.0*")
