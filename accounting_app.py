import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from datetime import datetime
import io
from PIL import Image

# --- 1. SETTINGS & STYLES ---
st.set_page_config(page_title="Meow Wallet Ultimate", layout="wide", page_icon="üêæ")

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap');
    .stApp { background-color: #FFF5F7 !important; }
    html, body, [class*="css"], .stMarkdown, p, span, label { 
        font-family: 'Kanit', sans-serif !important; 
        color: #2D2D2D !important;
    }
    .main-title { color: #FF69B4; text-align: center; font-size: 40px; font-weight: bold; padding: 15px; }
    div[data-testid="stMetric"] { background: white !important; border-radius: 15px; border: 2px solid #FFD1DC !important; padding: 15px; }
    .stButton>button { border-radius: 10px; }
    .badge-card {
        background: white; border-radius: 20px; padding: 20px; text-align: center;
        border: 2px solid #FFD1DC; margin-bottom: 20px; transition: 0.3s; height: 180px;
    }
    .badge-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(255,182,193,0.3); }
    .badge-icon { font-size: 50px; margin-bottom: 10px; }
    .badge-title { font-weight: bold; color: #FF69B4; font-size: 18px; }
    .badge-desc { font-size: 14px; color: #666; white-space: pre-wrap; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. DATABASE (‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û) ---
def get_db():
    conn = sqlite3.connect('meow_wallet_v33.db', check_same_thread=False)
    conn.row_factory = sqlite3.Row
    return conn

conn = get_db()
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS records 
             (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, date TEXT, 
              wallet TEXT, category TEXT, sub_category TEXT,
              income REAL DEFAULT 0, expense REAL DEFAULT 0, savings REAL DEFAULT 0,
              receipt_img BLOB)''')
# ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°
c.execute('''CREATE TABLE IF NOT EXISTS goals 
             (user_id TEXT PRIMARY KEY, goal_name TEXT, goal_amount REAL)''')
conn.commit()

# --- 3. LOGIN ---
if 'logged_in' not in st.session_state: st.session_state.logged_in = False
if 'user_name' not in st.session_state: st.session_state.user_name = ""

if not st.session_state.logged_in:
    st.markdown("<div class='main-title'>üêæ Meow Wallet üêæ</div>", unsafe_allow_html=True)
    _, col_l2, _ = st.columns([1, 2, 1])
    with col_l2:
        name_in = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß:", key="login_name")
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üêæ", use_container_width=True):
            if name_in.strip():
                st.session_state.user_name = name_in.strip()
                st.session_state.logged_in = True
                st.rerun()
    st.stop()

# --- 4. DATA LOADING ---
user_name = st.session_state.user_name
df = pd.read_sql(f"SELECT * FROM records WHERE user_id='{user_name}'", conn)
goal_data = c.execute("SELECT * FROM goals WHERE user_id=?", (user_name,)).fetchone()

total_in = df['income'].sum() if not df.empty else 0
total_out = df['expense'].sum() if not df.empty else 0
total_save = df['savings'].sum() if not df.empty else 0

# --- 5. TABS ---
tab1, tab2, tab3, tab4, tab5 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "üéØ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°", "üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"])

# --- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏û‡∏¥‡πà‡∏° Upload ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) ---
with tab1:
    st.markdown("### ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
    col1, col2 = st.columns(2)
    with col1:
        date_in = st.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
        wallet_in = st.selectbox("üëõ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
        type_in = st.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"], horizontal=True)
        uploaded_file = st.file_uploader("üì∏ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)", type=['jpg', 'jpeg', 'png'])
    with col2:
        cat_map = {"‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞": ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üí∏", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™ üéÅ", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á üõçÔ∏è", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"], "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏": ["‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç±", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° ‚òï", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á üöó", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á üõçÔ∏è", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"], "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑": ["‡∏≠‡∏≠‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß üè¶", "‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô üöë", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]}
        selected_cat = st.selectbox("üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", cat_map[type_in])
        final_cat = st.text_input("‚úçÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á") if selected_cat == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï" else selected_cat
        sub_cat = st.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î")
        amt = st.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0)

    if st.button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", use_container_width=True):
        if amt > 0:
            img_byte = uploaded_file.getvalue() if uploaded_file else None
            inc, exp, sav = (amt,0,0) if type_in=="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞" else (0,amt,0) if type_in=="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏" else (0,0,amt)
            c.execute("INSERT INTO records (user_id, date, wallet, category, sub_category, income, expense, savings, receipt_img) VALUES (?,?,?,?,?,?,?,?,?)", 
                      (user_name, date_in.strftime('%Y-%m-%d'), wallet_in, final_cat, sub_cat, inc, exp, sav, img_byte))
            conn.commit(); st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß!"); st.rerun()

# --- TAB 2 & 3 (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° Badge Logic ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£) ---
with tab2:
    st.markdown("### üè¶ ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠")
    cw1, cw2, cw3 = st.columns(3)
    for i, w in enumerate(["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"]):
        w_df = df[df['wallet'] == w] if not df.empty else pd.DataFrame()
        bal = w_df['income'].sum() - w_df['expense'].sum() - w_df['savings'].sum() if not w_df.empty else 0.0
        [cw1, cw2, cw3][i].metric(w, f"{bal:,.2f} ‡∏ø")

with tab3:
    st.markdown("### üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤")
    if not df.empty:
        ca1, ca2, ca3 = st.columns(3)
        # ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤ logic (v.32)
        exp_df = df[df['expense'] > 0]
        t_cat = exp_df.groupby('category')['expense'].sum().idxmax() if not exp_df.empty else "‡πÑ‡∏°‡πà‡∏°‡∏µ"
        t_amt = exp_df.groupby('category')['expense'].sum().max() if not exp_df.empty else 0
        e_icon, e_title = ("üõçÔ∏è", "‡∏ô‡∏±‡∏Å‡∏ä‡πâ‡∏≠‡∏õ‡∏°‡∏∑‡∏≠‡πÑ‡∏ß") if "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á" in t_cat else ("üçõ", "‡∏ô‡∏±‡∏Å‡∏ä‡∏¥‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏ô‡∏∂‡πà‡∏á") if "‡∏≠‡∏≤‡∏´‡∏≤‡∏£" in t_cat else ("üì¶", "‡∏ô‡∏±‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£")
        
        ca1.markdown(f"<div class='badge-card'><div class='badge-icon'>{e_icon}</div><div class='badge-title'>{e_title}</div><p class='badge-desc'>‡∏´‡∏°‡∏ß‡∏î {t_cat}\n{t_amt:,.0f} ‡∏ø</p></div>", unsafe_allow_html=True)
        # (ca2, ca3 ‡∏Ñ‡∏á logic ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏≠‡∏≠‡∏° ‡∏ï‡∏≤‡∏° v.32)
        st.plotly_chart(px.pie(names=['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°'], values=[total_out, total_save], hole=0.5, color_discrete_sequence=['#FF9AA2', '#B2E2F2']), use_container_width=True)
    else: st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß")

# --- TAB 4: ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° (NEW!) ---
with tab4:
    st.markdown("### üéØ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß")
    col_g1, col_g2 = st.columns([1, 1])
    with col_g1:
        new_g_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡πÅ‡∏°‡∏ß)", value=goal_data['goal_name'] if goal_data else "")
        new_g_amt = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ (‡∏ø)", value=float(goal_data['goal_amount'] if goal_data else 0.0))
        if st.button("üö© ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", use_container_width=True):
            c.execute("INSERT OR REPLACE INTO goals (user_id, goal_name, goal_amount) VALUES (?,?,?)", (user_name, new_g_name, new_g_amt))
            conn.commit(); st.success("‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); st.rerun()
    
    with col_g2:
        if goal_data and goal_data['goal_amount'] > 0:
            progress = min(total_save / goal_data['goal_amount'], 1.0)
            st.markdown(f"#### ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠: **{goal_data['goal_name']}**")
            st.metric("‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ", f"{total_save:,.2f} ‡∏ø")
            st.write(f"‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠ {goal_data['goal_amount']:,.2f} ‡∏ø")
            st.progress(progress)
            st.write(f"‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß {progress*100:.1f}%")
            if total_save < goal_data['goal_amount']:
                st.warning(f"‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å‡πÅ‡∏Ñ‡πà {goal_data['goal_amount'] - total_save:,.2f} ‡∏ø ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏™‡∏π‡πâ‡πÜ ‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß!")
            else:
                st.balloons(); st.success("üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")

# --- TAB 5: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) ---
with tab5:
    st.markdown("### üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à")
    if not df.empty:
        df_display = df.sort_values(by='id', ascending=False)
        st.dataframe(df_display.drop(columns=['user_id', 'receipt_img']), use_container_width=True)
        
        sel_id = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£:", df_display['id'].tolist())
        if sel_id:
            row = df[df['id'] == sel_id].iloc[0]
            if row['receipt_img']:
                st.image(row['receipt_img'], caption=f"‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà {sel_id}", width=300)
            else: st.write("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏ô‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß")
            
            # ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡πÄ‡∏î‡∏¥‡∏°
            ce1, ce2 = st.columns(2)
            if ce1.button("üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ", use_container_width=True):
                c.execute("DELETE FROM records WHERE id=?", (sel_id,))
                conn.commit(); st.rerun()

st.markdown("---")
if st.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"): st.session_state.logged_in = False; st.rerun()
