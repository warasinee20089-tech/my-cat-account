import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from datetime import datetime

# --- 1. SETTINGS & STYLES ---
st.set_page_config(page_title="Meow Wallet v.53", layout="wide", page_icon="üêæ")

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap');
    .stApp { background-color: #FFF0F5 !important; }
    html, body, [class*="css"], .stMarkdown, p, span, label { 
        font-family: 'Kanit', sans-serif !important; color: #4A4A4A !important;
    }
    .main-title { color: #FFB7CE; text-align: center; font-size: 40px; font-weight: bold; padding: 10px; }
    .meow-card { background: white; border-radius: 20px; padding: 15px; border: 2px solid #FFE4E1; margin-bottom: 15px; }
    .stButton>button { border-radius: 10px; background-color: #FFB7CE; color: white; border: none; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. DATABASE ENGINE ---
def init_db():
    conn = sqlite3.connect('meow_flexible_v53.db', check_same_thread=False)
    c = conn.cursor()
    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    c.execute('''CREATE TABLE IF NOT EXISTS records 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, date TEXT, 
                  wallet TEXT, category TEXT, sub_category TEXT,
                  income REAL DEFAULT 0, expense REAL DEFAULT 0, savings REAL DEFAULT 0,
                  receipt_img BLOB)''')
    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
    c.execute('''CREATE TABLE IF NOT EXISTS goals 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, goal_name TEXT, goal_amount REAL)''')
    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á
    c.execute('''CREATE TABLE IF NOT EXISTS custom_categories 
                 (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, type TEXT, name TEXT)''')
    conn.commit()
    return conn

conn = init_db()

# --- 3. LOGIN SYSTEM ---
if 'logged_in' not in st.session_state: st.session_state.logged_in = False
if 'user_name' not in st.session_state: st.session_state.user_name = ""

if not st.session_state.logged_in:
    st.markdown("<div class='main-title'>üêæ Meow Wallet üêæ</div>", unsafe_allow_html=True)
    _, col_login, _ = st.columns([1, 1.5, 1])
    with col_login:
        st.markdown("<h1 style='text-align: center; font-size: 80px;'>üê±</h1>", unsafe_allow_html=True)
        name_in = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß:", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...")
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üêæ", use_container_width=True):
            if name_in.strip():
                st.session_state.user_name = name_in.strip()
                st.session_state.logged_in = True
                st.rerun()
    st.stop()

user_name = st.session_state.user_name

# --- 4. LOAD DATA ---
df = pd.read_sql(f"SELECT * FROM records WHERE user_id='{user_name}'", conn)
if not df.empty:
    df['date'] = pd.to_datetime(df['date'])

# ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
total_save = df['savings'].sum() if not df.empty else 0

# --- 5. HEADER ---
st.markdown(f"<div class='main-title'>üêæ Meow Wallet: {user_name} üêæ</div>", unsafe_allow_html=True)

tab1, tab2, tab3, tab4, tab5 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", "üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"])

# --- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
with tab1:
    st.markdown("### ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
    col1, col2 = st.columns(2)
    with col1:
        d_in = st.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
        w_in = st.selectbox("üëõ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
        t_in = st.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞", "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"], horizontal=True)
        up_file = st.file_uploader("üì∏ ‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)", type=['jpg', 'jpeg', 'png'], key="add_img")
    
    with col2:
        # ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏≠‡∏á
        db_cats = pd.read_sql(f"SELECT name FROM custom_categories WHERE user_id='{user_name}' AND type='{t_in}'", conn)['name'].tolist()
        default_cats = ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á", "‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô"]
        all_cats = list(set(default_cats + db_cats))
        
        selected_cat = st.selectbox("üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", all_cats + ["+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà"])
        
        if selected_cat == "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà":
            new_cat_name = st.text_input("‚úçÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà")
            if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"):
                conn.execute("INSERT INTO custom_categories (user_id, type, name) VALUES (?,?,?)", (user_name, t_in, new_cat_name))
                conn.commit()
                st.rerun()
            final_cat = new_cat_name
        else:
            final_cat = selected_cat

        s_detail = st.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
        s_amt = st.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0, step=1.0)

    if st.button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"):
        if s_amt > 0 and final_cat:
            img_data = up_file.getvalue() if up_file else None
            inc = s_amt if t_in == "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞" else 0
            exp = s_amt if t_in == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏" else 0
            sav = s_amt if t_in == "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑" else 0
            conn.execute("INSERT INTO records (user_id, date, wallet, category, sub_category, income, expense, savings, receipt_img) VALUES (?,?,?,?,?,?,?,?,?)", 
                         (user_name, d_in.strftime('%Y-%m-%d'), w_in, final_cat, s_detail, inc, exp, sav, img_data))
            conn.commit(); st.rerun()

# --- TAB 2: ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô ---
with tab2:
    st.markdown("### üè¶ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠")
    w_cols = st.columns(3)
    for i, w_n in enumerate(["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"]):
        bal = 0
        if not df.empty:
            w_df = df[df['wallet'] == w_n]
            bal = w_df['income'].sum() - (w_df['expense'].sum() + w_df['savings'].sum())
        w_cols[i].metric(w_n, f"{bal:,.2f} ‡∏ø")

# --- TAB 3: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠) ---
with tab3:
    st.markdown("### üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô")
    if not df.empty:
        # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡∏á‡πà‡∏≤‡∏¢
        st.markdown("#### üìÖ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô")
        df['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'] = df['date'].dt.strftime('%m/%Y')
        m_data = df.groupby('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô')[['income', 'expense']].sum().reset_index()
        m_data = m_data.rename(columns={'income': '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', 'expense': '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'})
        
        fig_bar = px.bar(m_data, x='‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', y=['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'], barmode='group',
                         color_discrete_map={'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'#FFB7CE','‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢':'#B2E2F2'},
                         labels={'value': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)', 'variable': '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'})
        
        # ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡∏ô Y ‡πÉ‡∏´‡πâ‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏î‡∏π‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
        max_val = max(m_data['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'].max(), m_data['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'].max())
        fig_bar.update_layout(yaxis=dict(range=[0, max_val * 1.1]), font_family="Kanit")
        st.plotly_chart(fig_bar, use_container_width=True)

        c1, c2 = st.columns(2)
        with c1:
            st.markdown("#### üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà")
            inc_df = df[df['income'] > 0]
            if not inc_df.empty:
                st.plotly_chart(px.pie(inc_df, values='income', names='category', hole=0.4, color_discrete_sequence=px.colors.qualitative.Pastel), use_container_width=True)
        with c2:
            st.markdown("#### üç± ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà")
            exp_df = df[df['expense'] > 0]
            if not exp_df.empty:
                st.plotly_chart(px.pie(exp_df, values='expense', names='category', hole=0.4, color_discrete_sequence=px.colors.qualitative.Safe), use_container_width=True)
    else: st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß")

# --- TAB 4: ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö) ---
with tab4:
    st.markdown("### üéØ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°")
    col_g1, col_g2 = st.columns([1, 2])
    
    with col_g1:
        st.markdown("#### ‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà")
        gn = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢")
        ga = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", min_value=0.0)
        if st.button("üö© ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢"):
            conn.execute("INSERT INTO goals (user_id, goal_name, goal_amount) VALUES (?,?,?)", (user_name, gn, ga))
            conn.commit(); st.rerun()

    with col_g2:
        st.markdown("#### üèÜ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")
        goals_df = pd.read_sql(f"SELECT * FROM goals WHERE user_id='{user_name}'", conn)
        if not goals_df.empty:
            for index, row in goals_df.iterrows():
                with st.expander(f"üìå {row['goal_name']} - {row['goal_amount']:,.0f} ‡∏ø"):
                    p = min(total_save / row['goal_amount'], 1.0) if row['goal_amount'] > 0 else 0
                    st.progress(p)
                    st.write(f"‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß {total_save:,.2f} / {row['goal_amount']:,.2f} ‡∏ø ({(p*100):.1f}%)")
                    
                    c_edit1, c_edit2 = st.columns(2)
                    if c_edit1.button("üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", key=f"del_g_{row['id']}"):
                        conn.execute("DELETE FROM goals WHERE id=?", (row['id'],))
                        conn.commit(); st.rerun()
                    # (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠/‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
        else: st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢")

# --- TAB 5: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) ---
with tab5:
    st.markdown("### üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    if not df.empty:
        df_sh = df.sort_values(by='id', ascending=False)
        st.dataframe(df_sh.drop(columns=['user_id', 'receipt_img']), use_container_width=True)
        
        st.markdown("---")
        st.markdown("#### ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        sel_id = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ID ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£:", df_sh['id'].tolist())
        target = df[df['id'] == sel_id].iloc[0]
        
        with st.form(f"edit_form_{sel_id}"):
            col_e1, col_e2 = st.columns(2)
            with col_e1:
                e_date = st.date_input("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", pd.to_datetime(target['date']))
                e_cat = st.text_input("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", value=target['category'])
                e_amt = st.number_input("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô", value=float(max(target['income'], target['expense'], target['savings'])))
            with col_e2:
                e_sub = st.text_input("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", value=target['sub_category'])
                e_img = st.file_uploader("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à", type=['jpg','png'])
                if target['receipt_img']:
                    st.image(target['receipt_img'], width=150, caption="‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°")
            
            submit_edit = st.form_submit_button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            if submit_edit:
                # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                ni = e_amt if target['income'] > 0 else 0
                ne = e_amt if target['expense'] > 0 else 0
                ns = e_amt if target['savings'] > 0 else 0
                
                if e_img: # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
                    conn.execute("UPDATE records SET date=?, category=?, income=?, expense=?, savings=?, sub_category=?, receipt_img=? WHERE id=?", 
                                 (e_date.strftime('%Y-%m-%d'), e_cat, ni, ne, ns, e_sub, e_img.getvalue(), sel_id))
                else:
                    conn.execute("UPDATE records SET date=?, category=?, income=?, expense=?, savings=?, sub_category=? WHERE id=?", 
                                 (e_date.strftime('%Y-%m-%d'), e_cat, ni, ne, ns, e_sub, sel_id))
                conn.commit(); st.rerun()
        
        if st.button("üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£"):
            conn.execute("DELETE FROM records WHERE id=?", (sel_id,))
            conn.commit(); st.rerun()
