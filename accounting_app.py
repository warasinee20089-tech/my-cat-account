import streamlit as st
import sqlite3
import pandas as pd
from datetime import datetime
import plotly.express as px

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß", page_icon="üêæ", layout="wide")

st.markdown("""
<style>
    .stApp { background-color: #FFF0F5; }
    .stButton>button { background-color: #DB7093; color: white; border-radius: 10px; border: none; }
    .stButton>button:hover { background-color: #C71585; color: white; }
    h1, h2, h3, h4 { color: #4B0082; font-family: 'Sarabun', sans-serif; }
</style>
""", unsafe_allow_html=True)

# --- 2. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
def init_db():
    conn = sqlite3.connect('meow_wallet_final.db', check_same_thread=False)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            date TEXT,
            category TEXT,
            source TEXT,
            description TEXT,
            type TEXT,
            amount REAL
        )
    ''')
    conn.commit()
    return conn

conn = init_db()

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ ---
def get_all_categories():
    # ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    default_cats = ["‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç≤", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á üöó", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á üõçÔ∏è", "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üí∞", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á üì¶", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"]
    try:
        # ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô DB ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
        df = pd.read_sql("SELECT DISTINCT category FROM transactions", conn)
        db_cats = df['category'].dropna().unique().tolist()
        # ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ã‡πâ‡∏≥
        all_cats = list(set(default_cats + db_cats))
        all_cats.sort()
        return all_cats
    except:
        return default_cats

# --- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
if 'username' not in st.session_state:
    st.session_state.username = ""

def login():
    st.session_state.logged_in = True
    st.session_state.username = st.session_state.login_name_input

def logout():
    st.session_state.logged_in = False
    st.session_state.username = ""

# --- 4. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
if not st.session_state.logged_in:
    # ‡∏´‡∏ô‡πâ‡∏≤ Login
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.markdown("<h1 style='text-align: center;'>üêæ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß üêæ</h1>", unsafe_allow_html=True)
        st.markdown("<div style='text-align: center; font-size: 50px;'>üê±</div>", unsafe_allow_html=True)
        st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß:", key="login_name_input", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢...")
        st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üêæ", on_click=login, use_container_width=True)

else:
    # ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    st.markdown(f"<div style='text-align: right; color: #DB7093;'>üë§ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ: <b>{st.session_state.username}</b></div>", unsafe_allow_html=True)
    
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "üéØ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°", "üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"])

    # ---------------- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏â‡∏•‡∏≤‡∏î) ----------------
    with tab1:
        st.header(f"‚ú® ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
        with st.form("transaction_form", clear_on_submit=True):
            col1, col2 = st.columns(2)
            date_val = col1.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
            
            # --- ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÜ ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå ---
            existing_cats = get_all_categories()
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà" ‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î
            cat_options = existing_cats + ["‚ûï ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà..."]
            
            cat_choice = col2.selectbox("üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå)", cat_options)
            
            # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
            if cat_choice == "‚ûï ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà...":
                custom_cat = col2.text_input("‚úçÔ∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô, ‡πÉ‡∏™‡πà‡∏ã‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á")
                category = custom_cat if custom_cat else "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
            else:
                category = cat_choice
            
            col3, col4 = st.columns(2)
            source = col3.selectbox("üëõ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
            description = col4.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà")

            col5, col6 = st.columns(2)
            trans_type = col5.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"], horizontal=True)
            amount = col6.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0, format="%.2f")

            if st.form_submit_button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", use_container_width=True):
                c = conn.cursor()
                c.execute("INSERT INTO transactions (date, category, source, description, type, amount) VALUES (?, ?, ?, ?, ?, ?)",
                          (date_val, category, source, description, trans_type, amount))
                conn.commit()
                st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î '{category}' ‡πÅ‡∏•‡πâ‡∏ß! (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢)")

    # ---------------- TAB 2: ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ ----------------
    with tab2:
        st.header("üèõÔ∏è ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠")
        df = pd.read_sql_query("SELECT * FROM transactions", conn)
        
        def get_balance(source_name):
            d = df[df['source'] == source_name]
            inc = d[d['type'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞']['amount'].sum()
            exp = d[d['type'] == '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏']['amount'].sum()
            sav = d[d['type'] == '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑']['amount'].sum()
            return inc - exp - sav 

        c1, c2, c3 = st.columns(3)
        c1.metric("‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", f"{get_balance('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ'):,.2f} ‡∏ø")
        c2.metric("‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", f"{get_balance('‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶'):,.2f} ‡∏ø")
        c3.metric("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥", f"{get_balance('‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥'):,.2f} ‡∏ø")

    # ---------------- TAB 3: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ----------------
    with tab3:
        st.header("üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢")
        df = pd.read_sql_query("SELECT * FROM transactions", conn)
        expense_df = df[df['type'] == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏"]
        
        if not expense_df.empty:
            fig = px.pie(expense_df, values='amount', names='category', title='‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á', hole=0.4)
            st.plotly_chart(fig)
        else:
            st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢")

    # ---------------- TAB 4: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° ----------------
    with tab4:
        st.header("üéØ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°")
        df = pd.read_sql_query("SELECT * FROM transactions", conn)
        savings = df[df['type'] == "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"]['amount'].sum()
        
        st.metric("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°", f"{savings:,.2f} ‡∏ø")
        st.progress(min(savings/10000, 1.0))

    # ---------------- TAB 5: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà) ----------------
    with tab5:
        st.header("üìñ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
        df = pd.read_sql_query("SELECT * FROM transactions ORDER BY id DESC", conn)
        
        if not df.empty:
            df['‡∏•‡∏ö?'] = False
            st.info("üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà) / ‡∏ï‡∏¥‡πä‡∏Å‡∏ä‡πà‡∏≠‡∏á '‡∏•‡∏ö?' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö")
            
            # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Column Config ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞
            edited_df = st.data_editor(
                df, 
                column_config={
                    "‡∏•‡∏ö?": st.column_config.CheckboxColumn("‡∏•‡∏ö?", width="small"),
                    "category": st.column_config.TextColumn("‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)"), # ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    "amount": st.column_config.NumberColumn("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", format="%.2f"),
                },
                disabled=["id"],
                hide_index=True,
                use_container_width=True,
                key="editor"
            )

            col_btn1, col_btn2 = st.columns(2)
            
            # ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
            with col_btn1:
                if st.button("üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", type="primary", use_container_width=True):
                    to_delete = edited_df[edited_df['‡∏•‡∏ö?'] == True]['id'].tolist()
                    if to_delete:
                        cursor = conn.cursor()
                        for item_id in to_delete:
                            cursor.execute("DELETE FROM transactions WHERE id=?", (item_id,))
                        conn.commit()
                        st.success("‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!")
                        st.rerun()
            
            # ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            with col_btn2:
                if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", use_container_width=True):
                    save_df = edited_df.drop(columns=['‡∏•‡∏ö?'])
                    cursor = conn.cursor()
                    cursor.execute("DELETE FROM transactions") 
                    save_df.to_sql('transactions', conn, if_exists='append', index=False)
                    conn.commit()
                    st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!")
                    st.rerun()
        else:
            st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")

    st.markdown("---")
    if st.button("üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"):
        logout()
        st.rerun()
