import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Meow Wallet Ultimate v11.0 ---
st.set_page_config(page_title="Meow Wallet Ultimate", layout="wide", page_icon="üêæ")

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap');
    html, body, [class*="css"] { 
        font-family: 'Kanit', sans-serif; 
        color: #000000 !important;
    }
    .stApp { background-color: #FFF5F7; }
    .main-title { color: #FF69B4; text-align: center; font-size: 45px; font-weight: bold; padding: 10px; }
    div[data-testid="stMetric"] { background: white; border-radius: 15px; border: 1px solid #FFD1DC; padding: 15px; }
    .stProgress > div > div > div > div { background-color: #FF69B4; }
    .report-card { background-color: white; padding: 20px; border-radius: 15px; border-top: 5px solid #FF69B4; margin-bottom: 20px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); }
    </style>
    """, unsafe_allow_html=True)

# --- 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
conn = sqlite3.connect('meow_ultimate_v11.db', check_same_thread=False)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS records 
             (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, date TEXT, 
              wallet TEXT, category TEXT, sub_category TEXT,
              income REAL DEFAULT 0, expense REAL DEFAULT 0, savings REAL DEFAULT 0)''')
conn.commit()

# --- 3. Sidebar & Login ---
st.sidebar.markdown("<h2 style='text-align: center;'>üê± Meow Menu</h2>", unsafe_allow_html=True)
user_name = st.sidebar.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß", placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡πâ‡∏≤...")

if not user_name:
    st.markdown("<div class='main-title'>üêæ Meow Wallet Ultimate</div>", unsafe_allow_html=True)
    st.markdown("<h1 style='text-align: center; font-size: 80px;'>üí∞‚ú®</h1>")
    st.stop()

# --- 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
df = pd.read_sql(f"SELECT * FROM records WHERE user_id='{user_name}'", conn)
total_in = df['income'].sum() if not df.empty else 0
total_out = df['expense'].sum() if not df.empty else 0
total_save = df['savings'].sum() if not df.empty else 0
net_balance = total_in - total_out - total_save

# --- 5. ‡πÄ‡∏°‡∏ô‡∏π Tabs ---
tab1, tab2, tab3, tab4, tab5 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ô‡∏¥‡∏™‡∏±‡∏¢", "üéØ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°", "üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"])

with tab1:
    st.markdown(f"### ‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏∏‡∏ì {user_name})")
    col1, col2 = st.columns(2)
    
    with col1:
        date_in = st.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
        wallet_in = st.selectbox("üëõ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
        type_in = st.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"], horizontal=True)
    
    with col2:
        # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        if type_in == "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞":
            cat_list = ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üí∏", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™ üéÅ", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üõçÔ∏è", "‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏© üõ†Ô∏è", "‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç‡∏ñ‡∏∏‡∏á üßß", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]
        elif type_in == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏":
            cat_list = ["‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç±", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° ‚òï", "‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á üöó", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á üõçÔ∏è", "‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å üè†", "‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ ‚ö°", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]
        else: # ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°
            cat_list = ["‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß üè¶", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô üöë", "‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ üéÅ", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï"]
            
        selected_cat = st.selectbox("üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", cat_list)
        
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï" ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á
        final_category = selected_cat
        if selected_cat == "‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‚ûï":
            final_category = st.text_input("‚úçÔ∏è ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")
            
        sub_cat_in = st.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)", placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...")
        amt_in = st.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0, step=1.0)

    if st.button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"):
        if amt_in > 0 and final_category != "":
            inc, exp, sav = 0, 0, 0
            if type_in == "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞": inc = amt_in
            elif type_in == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏": exp = amt_in
            else: sav = amt_in
            
            c.execute("INSERT INTO records (user_id, date, wallet, category, sub_category, income, expense, savings) VALUES (?,?,?,?,?,?,?,?)", 
                      (user_name, date_in.strftime('%Y-%m-%d'), wallet_in, final_category, sub_cat_in, inc, exp, sav))
            conn.commit()
            st.balloons()
            st.rerun()

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ (‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô, ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå, ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥) ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 9.0 ---
with tab2:
    st.markdown("### üè¶ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠")
    df_w = pd.read_sql(f"SELECT wallet, SUM(income) as inc, SUM(expense) as exp, SUM(savings) as sav FROM records WHERE user_id='{user_name}' GROUP BY wallet", conn)
    cols = st.columns(3)
    wallets = ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"]
    for i, w_name in enumerate(wallets):
        row = df_w[df_w['wallet'] == w_name]
        bal = row['inc'].sum() - row['exp'].sum() - row['sav'].sum() if not row.empty else 0.0
        cols[i].metric(w_name, f"{bal:,.2f} ‡∏ø")

with tab3:
    st.markdown("### üìä Reports & Analytics")
    if not df.empty:
        st.markdown("<div class='report-card'><h4>ü•ß ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ vs ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</h4>", unsafe_allow_html=True)
        labels = ['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°']
        values = [total_out, total_save]
        fig = px.pie(names=labels, values=values, hole=0.5, color_discrete_sequence=['#EF553B', '#FF69B4'])
        st.plotly_chart(fig, use_container_width=True)
        st.markdown("</div>")

with tab4:
    st.markdown("### üéØ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°")
    st.metric("üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{total_save:,.2f} ‡∏ø")
    if total_in > 0:
        st.write(f"‡∏≠‡∏≠‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß {(total_save/total_in)*100:.1f}% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")

with tab5:
    st.markdown("### üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
    if not df.empty:
        df_display = df.sort_values(by=['date', 'id'], ascending=[False, False])
        st.dataframe(df_display[['date', 'wallet', 'category', 'sub_category', 'income', 'expense', 'savings']], use_container_width=True)
        csv = df_display.to_csv(index=False).encode('utf-8-sig')
        st.download_button(label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô CSV", data=csv, file_name=f'meow_backup_{user_name}.csv', mime='text/csv')

st.sidebar.markdown("---")
st.sidebar.write("üê± *Meow Wallet v11.0 (Smart Category)*")
