import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from datetime import datetime

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Meow Wallet Pro ---
st.set_page_config(page_title="Meow Wallet Pro", layout="wide", page_icon="üí∞")

# CSS ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÇ‡∏ó‡∏ô‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡πÅ‡∏•‡∏∞ UI ‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap');
    html, body, [class*="css"] { font-family: 'Kanit', sans-serif; }
    .stApp { background-color: #FFF5F7; }
    .main-title { color: #FF69B4; text-align: center; font-size: 45px; font-weight: bold; text-shadow: 2px 2px #FFE4E1; }
    .stButton>button { 
        background: linear-gradient(45deg, #FFB7C5, #FF99AC); 
        color: white; border-radius: 20px; border: none; font-weight: bold; width: 100%;
    }
    div[data-testid="stMetric"] { background: white; border-radius: 15px; border: 1px solid #FFD1DC; padding: 10px; }
    .invest-box { background-color: #E0F7FA; padding: 20px; border-radius: 15px; border-left: 5px solid #00ACC1; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Wallet ‡πÅ‡∏•‡∏∞ Sub-category) ---
conn = sqlite3.connect('meow_pro_v1.db', check_same_thread=False)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS records 
             (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id TEXT, date TEXT, 
              wallet TEXT, category TEXT, sub_category TEXT,
              income REAL DEFAULT 0, expense REAL DEFAULT 0)''')
conn.commit()

# --- 3. Sidebar & Login ---
st.sidebar.markdown("<h2 style='text-align: center;'>üê± Meow Menu</h2>", unsafe_allow_html=True)
user_name = st.sidebar.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß", placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡πâ‡∏≤...")

if not user_name:
    st.markdown("<div class='main-title'>üí∞ Meow Wallet Pro</div>", unsafe_allow_html=True)
    st.markdown("<h1 style='text-align: center; font-size: 100px;'>üê±‚ú®</h1>", unsafe_allow_html=True)
    st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ô‡∏∞‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß!")
    st.stop()

# --- 4. ‡πÄ‡∏°‡∏ô‡∏π Tabs ---
tab1, tab2, tab3, tab4 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô", "üìä ‡∏™‡∏£‡∏∏‡∏õ & ‡∏•‡∏á‡∏ó‡∏∏‡∏ô", "üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥"])

with tab1:
    st.markdown(f"### ‚ú® ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏∏‡∏ì {user_name})")
    col1, col2 = st.columns(2)
    
    with col1:
        date_in = st.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
        wallet_in = st.selectbox("üëõ ‡∏à‡πà‡∏≤‡∏¢/‡∏£‡∏±‡∏ö‡∏ú‡πà‡∏≤‡∏ô", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
        type_in = st.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞"], horizontal=True)
        
    with col2:
        main_cats = ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ", "‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]
        cat_in = st.selectbox("üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å", main_cats)
        sub_cat_in = st.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏¢‡πà‡∏≠‡∏¢ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ)", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï, ‡∏Å‡∏≤‡πÅ‡∏ü")
        amt_in = st.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)", min_value=0.0, step=1.0)

    if st.button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"):
        if amt_in > 0:
            inc, exp = (amt_in, 0) if "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö" in type_in else (0, amt_in)
            c.execute("INSERT INTO records (user_id, date, wallet, category, sub_category, income, expense) VALUES (?,?,?,?,?,?,?)", 
                      (user_name, date_in.strftime('%Y-%m-%d'), wallet_in, cat_in, sub_cat_in, inc, exp))
            conn.commit()
            st.balloons()
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤!")
            st.rerun()

with tab2:
    st.markdown("### üè¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô")
    df_w = pd.read_sql(f"SELECT wallet, SUM(income) as inc, SUM(expense) as exp FROM records WHERE user_id='{user_name}' GROUP BY wallet", conn)
    
    if not df_w.empty:
        cols = st.columns(3)
        wallets = ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"]
        for i, w_name in enumerate(wallets):
            row = df_w[df_w['wallet'] == w_name]
            balance = row['inc'].sum() - row['exp'].sum() if not row.empty else 0.0
            cols[i % 3].metric(w_name, f"{balance:,.2f} ‡∏ø")
    else:
        st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô")

with tab3:
    st.markdown("### üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° & ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô")
    df = pd.read_sql(f"SELECT * FROM records WHERE user_id='{user_name}'", conn)
    
    if not df.empty:
        total_in = df['income'].sum()
        total_out = df['expense'].sum()
        net_balance = total_in - total_out
        
        c1, c2 = st.columns(2)
        c1.metric("üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°", f"{total_in:,.2f}")
        c2.metric("üç¶ ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥", f"{net_balance:,.2f}")

        # --- AI Investment Logic ---
        st.markdown("---")
        st.markdown("#### ü§ñ Meow Advisor: ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô")
        
        risk_level = st.select_slider("üéØ ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ", options=["‡∏ï‡πà‡∏≥ (Low)", "‡∏Å‡∏•‡∏≤‡∏á (Medium)", "‡∏™‡∏π‡∏á (High)"])
        
        savings_ratio = (net_balance / total_in) * 100 if total_in > 0 else 0
        
        st.markdown(f"**Financial Health Check:** ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô `{savings_ratio:.1f}%` ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ")
        
        with st.expander("üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI"):
            if net_balance <= 0:
                st.warning("‚ö†Ô∏è ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ô‡∏∞‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß!")
            else:
                if savings_ratio > 20:
                    st.success("üåü ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:")
                
                if risk_level == "‡∏ï‡πà‡∏≥ (Low)":
                    st.info("**‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢! ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Money Market Fund)")
                elif risk_level == "‡∏Å‡∏•‡∏≤‡∏á (Medium)":
                    st.info("**‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏î‡∏∏‡∏•! ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏î‡∏±‡∏ä‡∏ô‡∏µ SET50 ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏Å‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ä‡∏±‡πâ‡∏ô‡∏ô‡∏≥ (Investment Grade)")
                else:
                    st.info("**‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:** ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï! ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏´‡∏∏‡πâ‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (‡πÄ‡∏ä‡πà‡∏ô S&P 500) ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏î‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏£‡∏±‡∏ö‡∏õ‡∏±‡∏ô‡∏ú‡∏•")

            # Compound Interest Forecast
            st.markdown("**üîÆ ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (5 ‡∏õ‡∏µ)**")
            rate = 5.0 if risk_level == "‡∏Å‡∏•‡∏≤‡∏á (Medium)" else (2.0 if risk_level == "‡∏ï‡πà‡∏≥ (Low)" else 10.0)
            future_val = net_balance * ((1 + (rate/100))**5)
            st.write(f"‡∏´‡∏≤‡∏Å‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ({net_balance:,.2f} ‡∏ø) ‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô `{rate}%` ‡∏ï‡πà‡∏≠‡∏õ‡∏µ ‡∏≠‡∏µ‡∏Å 5 ‡∏õ‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì `{future_val:,.2f} ‡∏ø` ‡πÄ‡∏°‡∏µ‡πä‡∏¢‡∏ß‡∏ß!")

with tab4:
    st.markdown("### üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏ï‡∏±‡∏ß")
    df_history = pd.read_sql(f"SELECT date as ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, wallet as ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤, category as ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà, sub_category as ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î, income as ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö, expense as ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ FROM records WHERE user_id='{user_name}' ORDER BY date DESC, id DESC", conn)
    
    if not df_history.empty:
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Running Balance)
        df_rev = df_history.iloc[::-1].copy()
        df_rev['‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'] = df_rev['‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö'].cumsum() - df_rev['‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'].cumsum()
        st.dataframe(df_rev.iloc[::-1], use_container_width=True)
    else:
        st.write("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")

st.sidebar.markdown("---")
st.sidebar.write("üê± *Meow Wallet Pro v2.0*")
