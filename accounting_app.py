import streamlit as st
import sqlite3
import pandas as pd
from datetime import datetime
import plotly.express as px

# --- 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Error ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô) ---
def safe_rerun():
    try:
        if hasattr(st, 'rerun'):
            st.rerun()
        elif hasattr(st, 'experimental_rerun'):
            st.experimental_rerun()
        else:
            st.write("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß! (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° R ‡∏ó‡∏µ‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)")
    except:
        st.write("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

# --- 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß", page_icon="üêæ", layout="wide")
st.markdown("""
<style>
    .stApp { background-color: #FFF0F5; }
    .stButton>button { background-color: #DB7093; color: white; border-radius: 10px; border: none; }
    .stButton>button:hover { background-color: #C71585; color: white; }
    h1, h2, h3, h4 { color: #4B0082; font-family: 'Sarabun', sans-serif; }
</style>
""", unsafe_allow_html=True)

# --- 3. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà v2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏Å‡πà‡∏≤) ---
def init_db():
    # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô meow_wallet_v2.db ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö
    conn = sqlite3.connect('meow_wallet_v2.db', check_same_thread=False)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            date TEXT,
            category TEXT,
            source TEXT,
            description TEXT,
            type TEXT,
            amount REAL
        )
    ''')
    conn.commit()
    return conn

conn = init_db()

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà Error) ---
def get_all_categories():
    default_cats = ["‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üç≤", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á üöó", "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á üõçÔ∏è", "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô üí∞", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á üì¶", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"]
    try:
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏´‡∏°
        df = pd.read_sql("SELECT * FROM transactions LIMIT 1", conn)
        # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏î‡∏∂‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏°‡∏≤
        df_cats = pd.read_sql("SELECT DISTINCT category FROM transactions", conn)
        db_cats = df_cats['category'].dropna().unique().tolist()
        all_cats = list(set(default_cats + db_cats))
        all_cats.sort()
        return all_cats
    except:
        return default_cats

# --- 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
if 'username' not in st.session_state:
    st.session_state.username = ""

def login():
    st.session_state.logged_in = True
    st.session_state.username = st.session_state.login_name_input

def logout():
    st.session_state.logged_in = False
    st.session_state.username = ""

# --- 5. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
if not st.session_state.logged_in:
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.markdown("<h1 style='text-align: center;'>üêæ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß üêæ</h1>", unsafe_allow_html=True)
        st.markdown("<div style='text-align: center; font-size: 50px;'>üê±</div>", unsafe_allow_html=True)
        st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏™‡πÅ‡∏°‡∏ß:", key="login_name_input", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢...")
        st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üêæ", on_click=login, use_container_width=True)

else:
    st.markdown(f"<div style='text-align: right; color: #DB7093;'>üë§ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ: <b>{st.session_state.username}</b></div>", unsafe_allow_html=True)
    
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", "üè¶ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤", "üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", "üéØ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°", "üìñ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"])

    # ---------------- TAB 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ----------------
    with tab1:
        st.header(f"‚ú® ‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà")
        with st.form("transaction_form", clear_on_submit=True):
            col1, col2 = st.columns(2)
            date_val = col1.date_input("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", datetime.now())
            
            existing_cats = get_all_categories()
            cat_options = existing_cats + ["‚ûï ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà..."]
            cat_choice = col2.selectbox("üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", cat_options)
            
            if cat_choice == "‚ûï ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà...":
                custom_cat = col2.text_input("‚úçÔ∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô, ‡πÉ‡∏™‡πà‡∏ã‡∏≠‡∏á")
                category = custom_cat if custom_cat else "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
            else:
                category = cat_choice
            
            col3, col4 = st.columns(2)
            source = col3.selectbox("üëõ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", "‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥"])
            description = col4.text_input("üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô‡πÑ‡∏Å‡πà")

            col5, col6 = st.columns(2)
            trans_type = col5.radio("üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", ["‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏", "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞", "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"], horizontal=True)
            amount = col6.number_input("üíµ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", min_value=0.0, format="%.2f")

            if st.form_submit_button("üíñ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", use_container_width=True):
                c = conn.cursor()
                c.execute("INSERT INTO transactions (date, category, source, description, type, amount) VALUES (?, ?, ?, ?, ?, ?)",
                          (date_val, category, source, description, trans_type, amount))
                conn.commit()
                st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î '{category}' ‡πÅ‡∏•‡πâ‡∏ß!")

    # ---------------- TAB 2: ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å Source ‡πÅ‡∏•‡πâ‡∏ß) ----------------
    with tab2:
        st.header("üèõÔ∏è ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠")
        df = pd.read_sql_query("SELECT * FROM transactions", conn)
        
        # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤
        if df.empty or 'source' not in df.columns:
            st.info("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢! (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà)")
        else:
            def get_balance(source_name):
                d = df[df['source'] == source_name]
                inc = d[d['type'] == '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö üí∞']['amount'].sum()
                exp = d[d['type'] == '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏']['amount'].sum()
                sav = d[d['type'] == '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑']['amount'].sum()
                return inc - exp - sav 

            c1, c2, c3 = st.columns(3)
            c1.metric("‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ", f"{get_balance('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î üíµ'):,.2f} ‡∏ø")
            c2.metric("‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶", f"{get_balance('‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ üè¶'):,.2f} ‡∏ø")
            c3.metric("‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥", f"{get_balance('‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï üí≥'):,.2f} ‡∏ø")

    # ---------------- TAB 3: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ----------------
    with tab3:
        st.header("üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢")
        df = pd.read_sql_query("SELECT * FROM transactions", conn)
        
        if not df.empty and 'type' in df.columns:
            expense_df = df[df['type'] == "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üí∏"]
            if not expense_df.empty:
                fig = px.pie(expense_df, values='amount', names='category', title='‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á', hole=0.4)
                st.plotly_chart(fig)
            else:
                st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢")
        else:
            st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")

    # ---------------- TAB 4: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏° ----------------
    with tab4:
        st.header("üéØ ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°")
        df = pd.read_sql_query("SELECT * FROM transactions", conn)
        
        if not df.empty and 'type' in df.columns:
            savings = df[df['type'] == "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° üê∑"]['amount'].sum()
            st.metric("‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°",
